<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,900" rel="stylesheet">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="./bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="./stylesheets/bootstrap.min.css">
    <style type="text/css">
        html {
            height: 100%
        }

        h1 {
            margin: 0 auto;
            font-size: 2.2em;
            text-align: center;
            color: #fff;
            font-size: 3em;
        }

        body {
            height: 100%;
            margin: 0;
            padding: 0
        }

        #map_canvas {
            height: 100%
        }
    </style>
    <link rel="stylesheet" type="text/css" href="./stylesheets/mystyle.css">

    <script type="text/javascript"
        src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAwY4VcLaEFb99Wrc835zkWmBCB6SCPy_4&sensor=false&callback=initialize">
        </script>
    <script type="text/javascript">
        var map;
        var markersArray = [];
        function initialize() {
            var mapOptions = {
                center: new google.maps.LatLng(-33.833578, 151.190872),
                zoom: 4,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById("map_canvas"),
                mapOptions);
        }
    </script>
    <script type="text/javascript" src="http://code.jquery.com/jquery-latest.min.js"></script>
</head>

<body onload="initialize()">
    <div class="headerCss">
        <div class="row">
            <h1>Top 15 best cities to visit in Australia</h1>
        </div>
        <div class="row" STYLE="text-align: center;">
            <label>   The color of markers below is based on our formula for weather condition .</label>
            <label>   Green means great, yellow means not so bad, red means bad.</label>
            <label>   Please choose the city you want to go and check weather information.</label>
        </div>
    </div>
    <div id="map_canvas" style="width:100%; height:97%"></div>

    <script type="text/javascript" src="/cc2/15cities.json"></script>
    <script type="text/javascript">

        $.ajax({
            type: "GET",
            dataType: "json",
            url: "/cc2/15cities.json",
            success: function (data) {
                $.each(data, function (i, item) {
                    var latLng = new google.maps.LatLng(item.latitude, item.longtitude);
                    var city = item.city;
                    var country = item.country;
                    console.log(city);
                    var score = 100;
                    var key = 'c31c30bf92f140deeb023ccb57878bec';
                    fetch('https://api.openweathermap.org/data/2.5/weather?q=' + city + '&appid=' + key)
                        .then(function (resp) { return resp.json() }) // Convert data to json
                        .then(function (data) {
                            console.log(data);
                            score = drawWeather(data, score);
                            var status = "";
                            if (score < 60) {
                                status = "bad";
                            } else if (score < 85) {
                                status = "good";
                            } else {
                                status = "great";
                            }

                            if (score < 60) {
                                addMarker(latLng, city, country, status, "blue");
                            } else if (score < 85) {
                                addMarker(latLng, city, country, status, "yellow");
                            } else {
                                addMarker(latLng, city, country, status, "green");
                            }

                            addMarker(latLng, citymcountry, "");
                            // // Creating a marker and putting it on the map
                            // var marker = new google.maps.Marker({
                            //     position: latLng,
                            //     title: item.city + "," + item.country,
                            //     map: map
                            // });
                            // // marker.setMap(map);
                            // //create info window

                            // // coordInfoWindow.open(map);
                            // marker.addListener('click', function () {
                            //     coordInfoWindow.open(marker.get('map'), marker);
                            // });
                        })
                        .catch(function () {
                            // catch any errors
                        });




                })

            }
        });

        function addMarker(latLng, city, country, status, color) {
            let url = "http://maps.google.com/mapfiles/ms/icons/";
            url += color + "-dot.png";

            let marker = new google.maps.Marker({
                map: map,
                position: latLng,
                title: city + "," + country,
                icon: {
                    url: url
                }
            });

            var coordInfoWindow = new google.maps.InfoWindow();
            coordInfoWindow.setContent(createInfoWindowContent(city, country, latLng, status));
            coordInfoWindow.setPosition(latLng);
            var center = latLng;
            map.panTo(center);

            marker.addListener('click', function () {
                coordInfoWindow.open(marker.get('map'), marker);
            });

            markersArray.push(marker);
        }

        function weatherCheck(cityName, score) {//check today's weather condition
            var key = 'c31c30bf92f140deeb023ccb57878bec';
            fetch('https://api.openweathermap.org/data/2.5/weather?q=' + cityName + '&appid=' + key)
                .then(function (resp) { return resp.json() }) // Convert data to json
                .then(function (data) {
                    console.log(data);
                    drawWeather(data, score);
                })
                .catch(function () {
                    // catch any errors
                });
        }
        //rules for the weather score
        //The total score is 100
        //if any possibility of rain, then minus 20.
        //if the gap between max temprature and min temprature is greater than 15 celcius, then minus 20
        //else if it is between 10~15, then minus 10
        //for the uv index, 3-5 minus 6, 6-7 minus 12, 8-10 minus 18 11plus minus 24
        //for heat index, accoding to wikipedia heat index. There are 4 index, which are caution, extrem caution, danger and extreme danger
        //for these indexes, we minus 10, 15,20 and 26 for each.
        //for temprature, if it is within 18-27, then it has full score of 24, otherwise, if min is less than 0 , then 0 point.
        //else if min is less than 10, minus 15, else if min is less than 18, minus 5.

        function drawWeather(d, score) {
            var celcius = Math.round(parseFloat(d.main.temp) - 273.15);
            var description = d.weather[0].description;
            // var iconurl = "http://openweathermap.org/img/w/" + iconcode + ".png";
            var humidity = d.main.humidity;
            var max = Math.round(parseFloat(d.main.temp_max) - 273.15);
            var min = Math.round(parseFloat(d.main.temp_min) - 273.15);
            console.log(max);
            console.log(min);
            console.log(humidity);

            if (description.indexOf('rain') > 0) {//rain 
                score = score - 20;
            }
            console.log(score);

            if ((max - min) > 15) {//gap between max and min temprature
                score = score - 20;
            } else if ((max - min) > 10) {
                score = score - 10;
            }
            console.log(score);

            if (max < 27) {//rules for temprature within 27 celcius
                if (min <= 0) {
                    score = score - 24;
                } else if (min <= 9) {
                    score = score - 15;
                } else if (min <= 17) {
                    score = score - 5;
                }
            }
            console.log(score);

            if (max >= 27) {//heat index
                if (max == 27) {
                    score = score - 10;
                } else if (max == 28) {
                    if (humidity <= 85) {
                        score = score - 10;
                    } else {
                        score = score - 15;
                    }
                } else if (max == 29) {
                    if (humidity <= 70) {
                        score = score - 10;
                    } else {
                        score = score - 15;
                    }
                } else if (max == 30) {
                    if (humidity <= 55) {
                        score = score - 10;
                    } else if (humidity <= 85) {
                        score = score - 15;
                    } else {
                        score = score - 20;
                    }
                } else if (max == 31) {
                    if (humidity <= 45) {
                        score = score - 10;
                    } else if (humidity <= 75) {
                        score = score - 15;
                    } else {
                        score = score - 20;
                    }
                } else if (max == 32) {
                    if (humidity <= 65) {
                        score = score - 15;
                    } else if (humidity <= 90) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 33) {
                    if (humidity <= 55) {
                        score = score - 15;
                    } else if (humidity <= 80) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 34) {
                    if (humidity <= 50) {
                        score = score - 15;
                    } else if (humidity <= 75) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 36) {
                    if (humidity <= 40) {
                        score = score - 15;
                    } else if (humidity <= 65) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 37) {
                    if (humidity <= 60) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 38) {
                    if (humidity <= 55) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 39) {
                    if (humidity <= 50) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 40) {
                    if (humidity <= 45) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else if (max == 41) {
                    if (humidity <= 40) {
                        score = score - 20;
                    } else {
                        score = score - 26;
                    }
                } else {
                    score = score - 26;
                }
            }
            return score;
            console.log(score);

        }


        function createInfoWindowContent(city, country, latLng, status) {
            var Coordinate = latLng;
            return [
                city + ' : ' + country,
                'LatLng: ' + latLng,
                'Weather status: ' + status,
                '<a href="/weather.html?cityName=' + encodeURI(city) + '">' + 'Weather Info' + '</a><br/>'
            ].join('<br>');
        }


    </script>
</body>

</html>